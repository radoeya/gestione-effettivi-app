<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Effettivi</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* gray-100 */
        }
        .form-input-box {
            background-color: #f9fafb; /* gray-50 */
            border-color: #d1d5db; /* gray-300 */
        }
        .form-input-box:focus {
            --tw-ring-color: rgb(59 130 246 / 0.5);
            border-color: #3b82f6; /* blue-500 */
        }
        .dynamic-row {
            border-left: 3px solid #d1d5db;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-gray-800 tracking-tight">Gestione Effettivi</h1>
            <p class="text-lg text-gray-500 mt-2">Strumento per la pianificazione e la comunicazione dei turni.</p>
        </header>

        <div class="flex flex-col gap-8">
            <div class="w-full bg-white p-6 rounded-2xl shadow-lg">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-y-8 md:gap-x-8">
                    <div class="md:col-span-1 md:border-r md:border-gray-200 md:pr-8">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Impostazione Report Annuncio</h2>
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-x-4">
                                <div>
                                    <label for="startDate" class="block text-sm font-medium text-gray-700">Validità Annuncio: Da</label>
                                    <input type="date" id="startDate" name="startDate" class="form-input-box mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-blue-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="endDate" class="block text-sm font-medium text-gray-700">A</label>
                                    <input type="date" id="endDate" name="endDate" class="form-input-box mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-blue-500 sm:text-sm">
                                </div>
                            </div>
                            <div>
                                <label for="depositoReport" class="block text-sm font-medium text-gray-700">Deposito</label>
                                <select id="depositoReport" class="form-input-box mt-1 block w-full pl-3 pr-10 py-2 text-base border focus:outline-none focus:ring-blue-500 sm:text-sm rounded-md">
                                    <option>Chiasso P</option>
                                    <option>Bellinzona P</option>
                                </select>
                            </div>
                            <hr class="my-4">
                            <div id="dynamic-entries-container" class="space-y-4"></div>

                            <div class="flex space-x-2">
                                <button id="add-shift-button" type="button" class="flex-1 text-sm py-2 px-3 border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50">➕ Aggiungi Turno da Coprire</button>
                                <button id="add-leave-button" type="button" class="flex-1 text-sm py-2 px-3 border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50">➕ Aggiungi Congedo Possibile</button>
                            </div>
                        </div>
                    </div>

                    <div class="md:col-span-1 md:pl-8">
                        <h2 class="text-xl font-semibold mb-4 text-gray-800">Azioni</h2>
                        <div class="space-y-4">
                            <button id="generateShortReportBtn" class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 h-5 w-5"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/></svg>
                                Genera Annuncio
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="reportModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden bg-gray-900 bg-opacity-50">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col transform transition-all scale-95 opacity-0">
                <div class="flex justify-between items-center p-6 border-b border-gray-200">
                    <h3 id="reportModalTitle" class="text-xl font-semibold text-gray-900">Report</h3>
                    <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></svg>
                    </button>
                </div>
                <div id="reportContent" class="p-6 overflow-y-auto bg-gray-50"></div>
                <div class="flex justify-end items-center p-6 border-t border-gray-200 bg-gray-100 rounded-b-2xl space-x-3">
                    <button id="downloadPdfBtn" class="flex items-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 h-4 w-4"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                        Scarica PDF
                    </button>
                </div>
            </div>
        </div>
        
        <div id="toast" class="fixed bottom-5 right-5 bg-gray-900 text-white py-3 px-5 rounded-lg shadow-xl opacity-0 translate-y-10 transition-all duration-300">
            <p id="toastMessage"></p>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- ELEMENTI DOM ---
        const generateShortReportBtn = document.getElementById('generateShortReportBtn');
        const modal = document.getElementById('reportModal');
        const reportModalTitle = document.getElementById('reportModalTitle');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');
        const reportContent = document.getElementById('reportContent');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');
        const addShiftButton = document.getElementById('add-shift-button');
        const addLeaveButton = document.getElementById('add-leave-button');
        const dynamicEntriesContainer = document.getElementById('dynamic-entries-container');
        
        // --- FUNZIONI ---
        function showToast(message) {
            if (!toast || !toastMessage) return;
            toastMessage.textContent = message;
            toast.classList.remove('opacity-0', 'translate-y-10');
            setTimeout(() => toast.classList.add('opacity-0', 'translate-y-10'), 3000);
        }

        function createShiftRow() {
            const rowId = `row-${Date.now()}`;
            const shiftRow = document.createElement('div');
            shiftRow.id = rowId;
            shiftRow.className = 'dynamic-row p-3 space-y-2 border-l-3 border-gray-300 bg-gray-50 rounded-r-lg';
            shiftRow.innerHTML = `
                <div class="flex justify-between items-center">
                    <label class="text-sm font-medium text-gray-800">Turno da Coprire</label>
                    <button type="button" onclick="document.getElementById('${rowId}').remove()" class="text-red-500 hover:text-red-700">➖ Rimuovi</button>
                </div>
                <div class="grid grid-cols-2 gap-x-2">
                    <input type="text" placeholder="Numero Turno" class="shift-number form-input-box w-full text-sm px-2 py-1 border rounded-md">
                    <input type="date" class="shift-date form-input-box w-full text-sm px-2 py-1 border rounded-md">
                </div>
                <div class="grid grid-cols-2 gap-x-2">
                    <input type="time" title="Ora inizio" class="shift-start-time form-input-box w-full text-sm px-2 py-1 border rounded-md">
                    <input type="time" title="Ora fine" class="shift-end-time form-input-box w-full text-sm px-2 py-1 border rounded-md">
                </div>
            `;
            dynamicEntriesContainer.appendChild(shiftRow);
        }

        function createLeaveRow() {
            const rowId = `row-${Date.now()}`;
            const leaveRow = document.createElement('div');
            leaveRow.id = rowId;
            leaveRow.className = 'dynamic-row p-3 space-y-2 border-l-3 border-green-300 bg-green-50 rounded-r-lg';
            leaveRow.innerHTML = `
                <div class="flex justify-between items-center">
                    <label class="text-sm font-medium text-green-800">Congedo Possibile</label>
                    <button type="button" onclick="document.getElementById('${rowId}').remove()" class="text-red-500 hover:text-red-700">➖ Rimuovi</button>
                </div>
                <input type="date" class="leave-date form-input-box w-full text-sm px-2 py-1 border rounded-md">
            `;
            dynamicEntriesContainer.appendChild(leaveRow);
        }

        function generateShiftAnnouncementData() {
            const formatDate = (dStr) => dStr ? new Date(dStr + 'T00:00:00').toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' }) : 'N/A';
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const deposito = document.getElementById('depositoReport').value;

            if (!startDate || !endDate) {
                showToast('Seleziona un periodo di validità per l\'annuncio.');
                return null;
            }

            // Raccogli dati turni
            const shifts = [];
            document.querySelectorAll('.dynamic-row').forEach(row => {
                const shiftNumberInput = row.querySelector('.shift-number');
                if (shiftNumberInput) { // È una riga di turno
                    const number = shiftNumberInput.value || 'N/D';
                    const date = row.querySelector('.shift-date').value;
                    const startTime = row.querySelector('.shift-start-time').value || 'N/D';
                    const endTime = row.querySelector('.shift-end-time').value || 'N/D';
                    if (date) shifts.push({ number, date, startTime, endTime });
                }
            });

            // Raccogli dati congedi
            const leaves = [];
            document.querySelectorAll('.dynamic-row').forEach(row => {
                const leaveDateInput = row.querySelector('.leave-date');
                if (leaveDateInput) { // È una riga di congedo
                    const date = leaveDateInput.value;
                    if (date) leaves.push({ date });
                }
            });
            
            if (shifts.length === 0 && leaves.length === 0) {
                showToast('Aggiungi almeno un turno o un congedo per creare un annuncio.');
                return null;
            }

            // Genera HTML per il report
            let shiftsHtml = '';
            if (shifts.length > 0) {
                shiftsHtml = `
                    <h3 style="font-size: 16px; font-weight: bold; margin-top: 15px; margin-bottom: 5px; border-bottom: 1px solid #ccc; padding-bottom: 3px;">Turni da Coprire</h3>
                    <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                        <thead><tr style="background-color: #e0e0e0;"><th style="border: 1px solid #000; padding: 5px;">Data</th><th style="border: 1px solid #000; padding: 5px;">Numero Turno</th><th style="border: 1px solid #000; padding: 5px;">Orario</th></tr></thead>
                        <tbody>
                            ${shifts.map(s => `<tr><td style="border: 1px solid #000; padding: 5px;">${formatDate(s.date)}</td><td style="border: 1px solid #000; padding: 5px;">${s.number}</td><td style="border: 1px solid #000; padding: 5px;">${s.startTime} - ${s.endTime}</td></tr>`).join('')}
                        </tbody>
                    </table>
                `;
            }

            let leavesHtml = '';
            if (leaves.length > 0) {
                leavesHtml = `
                    <h3 style="font-size: 16px; font-weight: bold; margin-top: 15px; margin-bottom: 5px; border-bottom: 1px solid #ccc; padding-bottom: 3px;">Congedi Possibili</h3>
                    <ul style="font-size: 14px; list-style-position: inside; padding-left: 5px;">
                        ${leaves.map(l => `<li>${formatDate(l.date)}</li>`).join('')}
                    </ul>
                `;
            }

            let reportHtml = `
                <div id="pdf-content" style="font-family: Arial, sans-serif; color: #000; border: 1px solid #000; padding: 20px;">
                    <h2 style="text-align:center;font-size:20px;font-weight:bold;margin:0 0 20px 0;">Annuncio Turni e Congedi</h2>
                    <p style="font-size: 14px;"><strong>Deposito:</strong> ${deposito}</p>
                    <p style="font-size: 14px;"><strong>Periodo di validità annuncio:</strong> dal ${formatDate(startDate)} al ${formatDate(endDate)}</p>
                    
                    ${shiftsHtml}
                    ${leavesHtml}

                    <br>
                    <p style="font-size: 14px; margin-top: 20px;">In caso di interesse, vogliate annunciarvi al più presto al numero di telefono:</p>
                    <p style="font-size: 18px; font-weight: bold; text-align: center; margin: 20px 0;">+41 51 285 11 11</p>
                    <p style="font-size: 14px;">Cordiali saluti e grazie per la collaborazione.</p>
                </div>`;
            
            return { html: reportHtml, stats: null };
        }

        function openModal(reportGenerator, title) {
            try {
                const reportData = reportGenerator();
                if (!reportData) return;
                
                reportModalTitle.textContent = title;
                reportContent.innerHTML = reportData.html;
                modal.classList.remove('hidden');
                setTimeout(() => modal.querySelector('div').classList.remove('scale-95', 'opacity-0'), 50);
            } catch (error) {
                console.error("ERRORE in openModal:", error);
                showToast(`Errore: ${error.message}.`);
            }
        }

        function closeModal() {
            modal.querySelector('div').classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        // --- EVENT LISTENERS ---
        addShiftButton.addEventListener('click', createShiftRow);
        addLeaveButton.addEventListener('click', createLeaveRow);
        generateShortReportBtn.addEventListener('click', () => openModal(generateShiftAnnouncementData, 'Annuncio Turni e Congedi'));
        closeModalBtn.addEventListener('click', closeModal);
        downloadPdfBtn.addEventListener('click', function() {
            const element = document.getElementById('pdf-content');
            if (!element) return;
            const filename = `Annuncio_Turni_Congedi.pdf`;
            const opt = {
                margin: [0.5, 0.5, 0.5, 0.5],
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, logging: false },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().from(element).set(opt).save();
        });
    });
    </script>
</body>
</html>
