<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Effettivi Dinamica</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://unpkg.com/split.js/dist/split.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; overflow: hidden; }
        .main-container { display: flex; flex-direction: column; height: 100vh; padding: 1rem 2rem 2rem 2rem; }
        header { flex-shrink: 0; padding-bottom: 1rem;}
        .content-wrapper { flex-grow: 1; display: flex; flex-direction: column; min-height: 0; }
        #vertical-split-container { display: flex; flex-direction: column; height: 100%; }
        #top-split-pane, #bottom-split-pane { overflow: hidden; }
        #top-split-pane { display: flex; flex-direction: row; background-color: #fff; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .split-pane { overflow-y: auto; overflow-x: hidden; padding: 1.25rem; }
        .gutter { background-color: #e5e7eb; background-repeat: no-repeat; background-position: 50%; }
        .gutter.gutter-horizontal { cursor: col-resize; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAFAQMAAABo7865AAAABlBMVEVHcEzMzMzyAv2sAAAAAXRSTlMAQObYZgAAABBJREFUeF5jOAMEEAIEEFwAn3kMwcB6I2AAAAAASUVORK5CYII='); }
        .gutter.gutter-vertical { cursor: row-resize; height: 10px; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAFAQMAAABo7865AAAABlBMVEVHcEzMzMzyAv2sAAAAAXRSTlMAQObYZgAAABBJREFUeF5jOAMEEAIEEFwAn3kMwcB6I2AAAAAASUVORK5CYII='); }
        .pane-header { padding-bottom: 1rem; margin-bottom: 1rem; border-bottom: 1px solid #e5e7eb; }
        .pane-controls button { background-color: #f3f4f6; border: 1px solid #e5e7eb; color: #6b7280; font-weight: bold; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 0.25rem; }
        .form-input-box { background-color: #f9fafb; border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.5rem 0.75rem; width: 100%; }
        #bottom-split-pane { display: flex; flex-direction: column; background-color: #fff; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .fc-event { cursor: pointer; }
        .parsed-info { min-height: 44px; border-width: 1px; border-color: #d1d5db; transition: all 0.2s ease-in-out; }
        .parsed-info.valid { border-color: #22c55e; background-color: #f0fdf4; }
        .parsed-info.invalid { border-color: #ef4444; background-color: #fef2f2; }

        /* Styles for Shift Fascia in new report */
        .fascia-presto { color: #1e40af; } /* blue-700 */
        .fascia-medio { color: #065f46; } /* green-800 */
        .fascia-tardi { color: #9a3412; } /* orange-800 */
        .fascia-sconosciuta { color: #6b7280; font-style: italic; }

        /* Styles for proposals block */
        .proposal-block {
            background-color: #ecfdf5; /* green-50 */
            border: 1px solid #34d399; /* green-400 */
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            position: relative;
        }

        .proposal-block.type-presto {
            background-color: #e0f2fe; /* blue-50 */
            border-color: #60a5fa; /* blue-400 */
        }

        .proposal-block.type-tardi {
            background-color: #fff7ed; /* orange-50 */
            border-color: #fb923c; /* orange-400 */
        }

        .proposal-block h4 {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .proposal-block p {
            font-size: 0.875rem;
            color: #4b5563;
        }
        /* Styles for interactive report in modal */
        .modal-shift-row {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            background-color: #f9fafb;
        }
        .modal-shift-row:nth-child(odd) {
            background-color: #ffffff; /* Alternate background for readability */
        }
        .modal-shift-row input[type="checkbox"] {
            margin-right: 15px;
            margin-top: 5px; /* Adjust vertical alignment */
            transform: scale(1.2); /* Make checkbox slightly larger */
            flex-shrink: 0;
        }
        .modal-shift-info {
            flex-grow: 1;
        }
        .modal-shift-info span {
            font-weight: 600;
            display: block;
            margin-bottom: 5px;
        }
        .modal-shift-info table {
            width: 100%;
            border-collapse: collapse;
        }
        .modal-shift-info th, .modal-shift-info td {
            padding: 4px 8px;
            border: 1px solid #e5e7eb;
            text-align: left;
            font-size: 0.875rem;
        }
        .modal-shift-info th {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="main-container">
        <header>
            <h1 class="text-4xl font-bold text-gray-800 tracking-tight text-center">Gestione Effettivi</h1>
            <p class="text-lg text-gray-500 mt-2 text-center">Strumento per la pianificazione e la comunicazione dello stato degli effettivi.</p>
            <div class="text-center mt-4">
                <a href="https://bilanciamento.onrender.com" target="_blank" rel="noopener noreferrer" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-teal-600 hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500">
                    Bilanciamento Personale
                </a>
            </div>
        </header>

        <div class="content-wrapper">
            <div id="vertical-split-container">
                <div id="top-split-pane">
                    <div id="pane1" class="split-pane">
                        <div class="pane-header flex justify-between items-center"><h2 class="text-xl font-semibold text-gray-800">Impostazioni e Calendario</h2><div class="pane-controls flex gap-2"><button data-action="maximize" data-pane-index="0" title="Massimizza">□</button><button data-action="toggle" data-pane-index="0" title="Chiudi/Ripristina">X</button></div></div>
                        <div class="pane-content space-y-4">
                            <h3 class="text-lg font-semibold text-gray-700">Report Mensile</h3>
                            <div><label for="deposito" class="block text-sm font-medium">Deposito</label><select id="deposito" class="form-input-box mt-1"><option>Chiasso P</option><option>Bellinzona P</option></select></div>
                            <div><label for="particolarita" class="block text-sm font-medium">Particolarità del mese</label><input type="text" id="particolarita" placeholder="Es: Evento speciale..." class="form-input-box mt-1"></div>
                            <hr>
                            <form id="entryForm" class="space-y-4">
                                <h3 class="text-lg font-semibold text-gray-700">Aggiungi Voce al Calendario</h3>
                                <div><label for="entryDate" class="block text-sm font-medium text-gray-700">Data</label><input type="date" id="entryDate" name="entryDate" class="form-input-box mt-1" required></div>
                                <div class="grid grid-cols-3 gap-x-2">
                                    <div>
                                        <label for="entryType" class="block text-sm font-medium">Tipo</label>
                                        <select id="entryType" name="entryType" class="form-input-box mt-1">
                                            <option value="need">Turni</option>
                                            <option value="leave">Congedi</option>
                                            <option value="availability">Disponibilità</option>
                                        </select>
                                    </div>
                                    <div><label for="shiftType" class="block text-sm font-medium">Turno</label><select id="shiftType" name="shiftType" class="form-input-box mt-1"><option value="early">Presto</option><option value="medium">Medio</option><option value="late">Tardi</option></select></div>
                                    <div><label for="quantity" class="block text-sm font-medium">Qtà</label><input type="number" id="quantity" name="quantity" min="1" value="1" class="form-input-box mt-1" required></div>
                                </div>
                                <button type="submit" class="w-full flex justify-center items-center py-3 px-4 border rounded-lg text-white bg-blue-600 hover:bg-blue-700">Aggiungi al Calendario</button>
                            </form>
                             <div class="mt-6 pt-4 border-t">
                                 <button id="generateReportBtn" class="w-full flex justify-center items-center py-3 px-4 border rounded-lg text-white bg-gray-800 hover:bg-gray-900">Genera Report Mensile</button>
                             </div>
                        </div>
                    </div>
                    <div id="pane2" class="split-pane">
                        <div class="pane-header flex justify-between items-center"><h2 class="text-xl font-semibold text-gray-800">Annuncio Effettivi</h2><div class="pane-controls flex gap-2"><button data-action="maximize" data-pane-index="1" title="Massimizza">□</button><button data-action="toggle" data-pane-index="1" title="Chiudi/Ripristina">X</button></div></div>
                        <div class="pane-content space-y-4">
                            <div class="grid grid-cols-2 gap-x-4">
                                <div><label for="startDate" class="block text-sm font-medium">Da (data)</label><input type="date" id="startDate" name="startDate" class="form-input-box mt-1"></div>
                                <div><label for="endDate" class="block text-sm font-medium">A (data)</label><input type="date" id="endDate" name="endDate" class="form-input-box mt-1"></div>
                            </div>
                            <hr><h3 class="text-lg font-semibold">Turni da Coprire</h3>
                            <div class="mt-2 space-y-2">
                                <label for="depositoReport" class="block text-sm font-medium">Deposito</label>
                                <select id="depositoReport" class="form-input-box mt-1"><option>Chiasso P</option><option>Bellinzona P</option></select>
                                <div class="mt-4"><label for="quick-add-turno" class="block text-sm font-medium">Incolla Turno</label><div class="flex gap-2"><input type="text" id="quick-add-turno" placeholder="Incolla qui la riga del turno..." class="form-input-box flex-grow"><button id="quick-add-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Aggiungi</button></div></div>
                                <div id="turniContainer" class="space-y-3 pt-2"></div>
                                <button id="addTurnoBtn" type="button" class="w-full flex justify-center items-center mt-2 py-2 px-4 border border-dashed rounded-lg">Aggiungi Turno Manuale</button>
                            </div>
                            <hr><h3 class="text-lg font-semibold">Congedi Disponibili</h3>
                            <div class="mt-2 space-y-2">
                                <div id="congediContainer" class="space-y-3 pt-2"></div>
                                <button id="addCongedoBtn" type="button" class="w-full flex justify-center items-center mt-2 py-2 px-4 border border-dashed rounded-lg">Aggiungi Congedo</button>
                            </div>
                             <div class="mt-6 pt-4 border-t space-y-2">
                                 <button id="generateShortReportBtn" class="w-full flex justify-center items-center py-3 px-4 border rounded-lg text-white bg-blue-600 hover:bg-blue-700">Genera Annuncio Effettivi</button>
                                 <button id="clearAllBtn" class="w-full flex justify-center items-center py-3 px-4 border border-red-500 rounded-lg text-red-600 bg-white hover:bg-red-50">Pulisci Dati Annuncio</button>
                             </div>
                        </div>
                    </div>
                    <div id="pane3" class="split-pane">
                        <div class="pane-header flex justify-between items-center"><h2 class="text-xl font-semibold text-gray-800">Statistiche e Analisi</h2><div class="pane-controls flex gap-2"><button data-action="maximize" data-pane-index="2" title="Massimizza">□</button><button data-action="toggle" data-pane-index="2" title="Chiudi/Ripristina">X</button></div></div>
                        <div class="pane-content space-y-4">
                            <h3 class="text-lg font-semibold">Stato Richieste (Manuale)</h3>
                            <p class="text-xs text-gray-500">I valori qui vengono usati nel report mensile e popolati dall'analisi testo.</p>
                            <div><label for="statsAccepted" class="block text-sm font-medium">Accettate</label><input type="number" id="statsAccepted" placeholder="0" min="0" class="form-input-box mt-1"></div>
                            <div><label for="statsPending" class="block text-sm font-medium">In Sospeso</label><input type="number" id="statsPending" placeholder="0" min="0" class="form-input-box mt-1"></div>
                            <div><label for="statsRejected" class="block text-sm font-medium">Respinte</label><input type="number" id="statsRejected" placeholder="0" min="0" class="form-input-box mt-1"></div>
                            <hr class="my-6">
                            <div class="flex-grow flex flex-col space-y-4">
                                <label for="paste-area" class="block text-sm font-medium">Incolla qui i dati da analizzare:</label>
                                <textarea id="paste-area" class="form-input-box w-full flex-grow" rows="4"></textarea>
                                <button id="analyze-btn" class="w-full flex justify-center items-center py-3 px-4 border rounded-lg text-white bg-purple-600 hover:bg-purple-700">Analizza e Compila</button>
                            </div>
                        </div>
                    </div>
                    <div id="pane4" class="split-pane flex flex-col">
                        <div class="pane-header flex justify-between items-center">
                            <h2 class="text-xl font-semibold text-gray-800">Gestione Cambi</h2>
                            <div class="pane-controls flex gap-2">
                                <button data-action="maximize" data-pane-index="3" title="Massimizza">□</button>
                                <button data-action="toggle" data-pane-index="3" title="Chiudi/Ripristina">X</button>
                            </div>
                        </div>
                        <div class="pane-content flex-grow flex flex-col space-y-4">
                             <div id="swap-blocks-container" class="flex-grow space-y-4 overflow-y-auto pr-2">
                             </div>
                             <div class="pt-4 border-t">
                                 <button id="add-new-swap-block-btn" class="w-full flex justify-center items-center py-3 px-4 border rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 font-semibold">
                                     + Aggiungi Blocco Cambio
                                 </button>
                             </div>
                        </div>
                    </div>
                    <div id="pane5" class="split-pane flex flex-col">
                        <div class="pane-header flex justify-between items-center"><h2 class="text-xl font-semibold text-gray-800">Attesa Turno</h2><div class="pane-controls flex gap-2"><button data-action="maximize" data-pane-index="4" title="Massimizza">□</button><button data-action="toggle" data-pane-index="4" title="Chiudi/Ripristina">X</button></div></div>
                        <div class="pane-content flex-grow flex flex-col space-y-4">
                            <label for="standby-paste-area" class="block text-sm font-medium">Incolla qui la lista del personale:</label>
                            <textarea id="standby-paste-area" class="form-input-box w-full flex-grow" rows="5"></textarea>
                            <button id="process-standby-btn" class="w-full flex justify-center items-center py-3 px-4 border rounded-lg text-white bg-orange-600 hover:bg-orange-700">Elabora Lista</button>
                            <hr>
                            <div id="standby-results-container" class="space-y-2"></div>
                        </div>
                    </div>
                    <div id="pane6" class="split-pane flex flex-col">
                        <div class="pane-header flex justify-between items-center">
                            <h2 class="text-xl font-semibold text-gray-800">Cambio Fascia Oraria</h2>
                            <div class="pane-controls flex gap-2">
                                <button data-action="maximize" data-pane-index="5" title="Massimizza">□</button>
                                <button data-action="toggle" data-pane-index="5" title="Chiudi/Ripristina">X</button>
                            </div>
                        </div>
                        <div class="pane-content flex-grow flex flex-col space-y-4">
                            <div>
                                <label for="shift-data-paste-area" class="block text-sm font-medium">Incolla Dati Turni Macchinista:</label>
                                <textarea id="shift-data-paste-area" class="form-input-box w-full mt-1" rows="8" placeholder="Incolla qui le righe complete dei turni (es. Cerutti	Marco	01.07.2025	8001	14:39	23:30	8:51	8:39		01.07.2025 15:33:27..."></textarea>
                                <button id="process-shift-data-btn" class="w-full flex justify-center items-center py-2 px-4 border rounded-lg text-white bg-blue-600 hover:bg-blue-700 font-semibold mt-2">Organizza Turni</button>
                            </div>
                            <hr class="my-4">
                            <h3 class="text-lg font-semibold text-gray-700">Proposte di Cambio Fascia</h3>
                            <div id="fascia-cambi-proposti-container" class="flex-grow space-y-3 overflow-y-auto pr-2">
                                <p class="text-gray-500 text-sm">Organizza i turni per vedere le proposte di cambio.</p>
                                </div>
                        </div>
                    </div>

                </div>
                
                <div id="bottom-split-pane">
                    <div id="calendar" class="h-full"></div>
                </div>
            </div>
        </div>
        
        <div id="addEventModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden" style="background-color: rgba(0,0,0,0.5);">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md flex flex-col">
                <div class="flex justify-between items-center p-6 border-b"><h3 class="text-xl font-semibold">Aggiungi Voce per il Giorno</h3><button id="closeAddEventModalBtn" class="text-gray-400 hover:text-gray-600">X</button></div>
                <div class="p-6">
                    <form id="modalEntryForm" class="space-y-4">
                        <div><label for="modalEntryDate" class="block text-sm font-medium text-gray-700">Data</label><input type="date" id="modalEntryDate" name="entryDate" class="form-input-box mt-1 bg-gray-200" readonly></div>
                       <div class="grid grid-cols-3 gap-x-2">
                            <div>
                                <label for="modalEntryType" class="block text-sm font-medium">Tipo</label>
                                <select id="modalEntryType" name="entryType" class="form-input-box mt-1">
                                    <option value="need">Turni</option>
                                    <option value="leave">Congedi</option>
                                    <option value="availability">Disponibilità</option>
                                </select>
                            </div>
                            <div><label for="modalShiftType" class="block text-sm font-medium">Turno</label><select id="modalShiftType" name="shiftType" class="form-input-box mt-1"><option value="early">Presto</option><option value="medium">Medio</option><option value="late">Tardi</option></select></div>
                            <div><label for="modalQuantity" class="block text-sm font-medium">Qtà</label><input type="number" id="modalQuantity" name="quantity" min="1" value="1" class="form-input-box mt-1" required></div>
                       </div>
                        <button type="submit" class="w-full flex justify-center items-center py-3 px-4 border rounded-lg text-white bg-blue-600 hover:bg-blue-700">Aggiungi</button>
                    </form>
                </div>
            </div>
        </div>

        <div id="reportModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden" style="background-color: rgba(0,0,0,0.5);">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center p-6 border-b"><h3 id="reportModalTitle" class="text-xl font-semibold">Report</h3><div class="flex items-center gap-4"><button id="openNewTabBtn" class="text-gray-400 hover:text-gray-600" title="Apri in nuova scheda"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></svg></button><button id="closeModalBtn" class="text-gray-400 hover:text-gray-600">X</button></div></div>
                <div id="reportContent" class="p-6 overflow-y-auto bg-gray-50"></div>
                <div class="flex justify-end items-center p-6 border-t bg-gray-100 rounded-b-2xl space-x-3">
                    <button id="copyHtmlBtn" class="flex items-center py-2 px-4 border rounded-lg">Copia HTML</button>
                    <button id="sendEmailBtn" class="flex items-center py-2 px-4 border rounded-lg text-white bg-teal-600 hover:bg-teal-700">Invia Email</button>
                    <button id="downloadPdfBtn" class="flex items-center py-2 px-4 border rounded-lg text-white bg-blue-600">Scarica PDF</button>
                    <button id="generateSelectedShiftsEmailBtn" class="flex items-center py-2 px-4 border rounded-lg text-white bg-green-600 hover:bg-green-700 hidden">Genera Email Selezionati</button>
                </div>
            </div>
        </div>
        
        <div id="toast" class="fixed bottom-5 right-5 bg-gray-900 text-white py-3 px-5 rounded-lg shadow-xl opacity-0 translate-y-10 transition-all"><p id="toastMessage"></p></div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        try {
            // --- INIZIALIZZAZIONE GLOBALE VARIABILI ---
            const calendarEl = document.getElementById('calendar');
            const entryForm = document.getElementById('entryForm');
            const generateReportBtn = document.getElementById('generateReportBtn');
            const downloadPdfBtn = document.getElementById('downloadPdfBtn');
            const reportContent = document.getElementById('reportContent');
            const reportModal = document.getElementById('reportModal');
            const reportModalTitle = document.getElementById('reportModalTitle');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const statsAcceptedInput = document.getElementById('statsAccepted');
            const statsPendingInput = document.getElementById('statsPending');
            const statsRejectedInput = document.getElementById('statsRejected');
            
            const typeTranslations = {
                need: 'Turni',
                leave: 'Congedi',
                availability: 'Disponibilità'
            };
            const typeColors = {
                need: '#ef4444',    // red-500
                leave: '#22c55e',   // green-500
                availability: '#4ade80' // green-400 (lighter green)
            };

            // Aggiorna paneElementsH per includere il nuovo pane6
            const paneElementsH = ['#pane1', '#pane2', '#pane3', '#pane4', '#pane5', '#pane6'];
            // Aggiorna initialSizesH per bilanciare i 6 pannelli
            const initialSizesH = Array(paneElementsH.length).fill(100 / paneElementsH.length);  
            let horizontalSplitInstance = null;  

            function initializeHorizontalSplit() {
                if (horizontalSplitInstance) {
                    horizontalSplitInstance.destroy();  
                }
                horizontalSplitInstance = Split(paneElementsH, {  
                    sizes: initialSizesH,  
                    minSize: 60,  
                    gutterSize: 10,  
                    direction: 'horizontal',  
                    cursor: 'col-resize'  
                });
            }

            initializeHorizontalSplit();
            
            const initialSizesV = [60, 40];
            let calendar = null;
            const verticalSplit = Split(['#top-split-pane', '#bottom-split-pane'], {  
                sizes: initialSizesV,  
                minSize: 150,  
                gutterSize: 10,  
                direction: 'vertical',  
                cursor: 'row-resize',  
                onDragEnd: function() {  
                    if(calendar) calendar.updateSize();  
                }  
            });
            
            document.getElementById('top-split-pane').addEventListener('click', function(e) {
                const button = e.target.closest('button[data-action]');
                if (!button) return;
                const action = button.dataset.action;
                const paneIndex = parseInt(button.dataset.paneIndex, 10);
                const pane = document.getElementById(`pane${paneIndex + 1}`);

                if (action === 'toggle') {
                    const isCollapsed = horizontalSplitInstance.getSizes()[paneIndex] < 5;
                    
                    if (isCollapsed) {
                        const defaultSizes = Array(paneElementsH.length).fill(100 / paneElementsH.length);  
                        horizontalSplitInstance.setSizes(defaultSizes);
                        pane.style.display = 'flex';  
                    } else {
                        horizontalSplitInstance.collapse(paneIndex);
                    }
                } else if (action === 'maximize') {
                    const isMaximized = pane.dataset.maximized === 'true';
                    if (isMaximized) {
                        pane.dataset.maximized = 'false';
                        const defaultSizes = Array(paneElementsH.length).fill(100 / paneElementsH.length);
                        horizontalSplitInstance.setSizes(defaultSizes);
                        paneElementsH.forEach(selector => {
                            document.querySelector(selector).style.display = 'flex';
                        });
                    } else {
                        document.querySelectorAll('.split-pane').forEach((p, i) => {  
                            p.dataset.maximized = 'false';  
                            if (i !== paneIndex) {
                                p.style.display = 'none';  
                            }
                        });
                        pane.style.display = 'flex';  
                        const newSizes = Array(paneElementsH.length).fill(0);
                        newSizes[paneIndex] = 100;  
                        horizontalSplitInstance.setSizes(newSizes);
                        pane.dataset.maximized = 'true';
                    }
                }
                if(calendar) calendar.updateSize();
            });

            const generateShortReportBtn = document.getElementById('generateShortReportBtn');
            const clearAllBtn = document.getElementById('clearAllBtn');
            const openNewTabBtn = document.getElementById('openNewTabBtn');
            const copyHtmlBtn = document.getElementById('copyHtmlBtn');
            const sendEmailBtn = document.getElementById('sendEmailBtn'); // This is the old send email button, not for selected shifts
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            document.getElementById('entryDate').value = new Date().toISOString().slice(0, 10);
            let currentReportGenerator = null;
            const depositoReportSelect = document.getElementById('depositoReport');
            const addTurnoBtn = document.getElementById('addTurnoBtn');
            const turniContainer = document.getElementById('turniContainer');
            const addCongedoBtn = document.getElementById('addCongedoBtn');
            const congediContainer = document.getElementById('congediContainer');
            let turniPerDeposito = {};
            let congediDaOffrire = [];
            let depositoPrecedente = depositoReportSelect.value;
            const pasteArea = document.getElementById('paste-area');
            const analyzeBtn = document.getElementById('analyze-btn');
            const quickAddTurnoInput = document.getElementById('quick-add-turno');
            const quickAddBtn = document.getElementById('quick-add-btn');
            const addEventModal = document.getElementById('addEventModal');
            const modalEntryForm = document.getElementById('modalEntryForm');
            const closeAddEventModalBtn = document.getElementById('closeAddEventModalBtn');
            const standbyPasteArea = document.getElementById('standby-paste-area');
            const processStandbyBtn = document.getElementById('process-standby-btn');
            const standbyResultsContainer = document.getElementById('standby-results-container');
            
            // --- GESTIONE CALENDARIO ---
            const storageKey = 'calendarEvents_v20';
            let calendarEvents = [];
            try {
                const storedEvents = localStorage.getItem(storageKey);
                if (storedEvents) calendarEvents = JSON.parse(storedEvents);
            } catch (e) { console.error("Errore localStorage", e); }

            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth', locale: 'it',
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,dayGridWeek' },
                events: calendarEvents,
                dateClick: function(info) {
                    document.getElementById('modalEntryDate').value = info.dateStr;
                    addEventModal.classList.remove('hidden');
                },
                eventClick: function(info) {
                    const eventId = info.event.id;
                    const eventIndex = calendarEvents.findIndex(ev => ev.id === eventId);
                    if (eventIndex > -1) {
                        calendarEvents[eventIndex].extendedProps.quantity--;
                        if (calendarEvents[eventIndex].extendedProps.quantity <= 0) {
                            calendarEvents.splice(eventIndex, 1);
                            showToast('Gruppo di eventi rimosso.');
                        } else {
                            const eventData = calendarEvents[eventIndex];
                            const props = eventData.extendedProps;
                            const shiftTranslations = { early: 'Presto', medium: 'Medio', late: 'Tardi' };
                            eventData.title = `${typeTranslations[props.type] || 'Evento'}: ${props.quantity} ${shiftTranslations[props.shift]}`;
                            showToast('Quantità ridotta.');
                        }
                        saveAndRerender();
                    }
                },
                editable: false, dayMaxEvents: 4, height: '100%'
            });
            calendar.render();
            
            function showToast(message) {
                toastMessage.textContent = message;
                toast.classList.remove('opacity-0', 'translate-y-10');
                setTimeout(() => toast.classList.add('opacity-0', 'translate-y-10'), 3000);
            }

            function saveAndRerender() {
                localStorage.setItem(storageKey, JSON.stringify(calendarEvents));
                calendar.removeAllEvents();
                calendar.addEventSource(calendarEvents);
            }

            function addOrUpdateCalendarEvent(date, type, shift, quantity) {
                if (!date || !type || !shift || isNaN(quantity)) {
                    showToast("Per favore, compila tutti i campi.");
                    return;
                }
                const shiftTranslations = { early: 'Presto', medium: 'Medio', late: 'Tardi' };
                const eventId = `${date}-${type}-${shift}`;
                const existingEventIndex = calendarEvents.findIndex(ev => ev.id === eventId);
                
                const newTitle = (currentQty) => `${typeTranslations[type] || 'Evento'}: ${currentQty} ${shiftTranslations[shift]}`;

                if (existingEventIndex > -1) {
                    calendarEvents[existingEventIndex].extendedProps.quantity += quantity;
                    calendarEvents[existingEventIndex].title = newTitle(calendarEvents[existingEventIndex].extendedProps.quantity);
                } else {
                    calendarEvents.push({  
                        id: eventId,  
                        title: newTitle(quantity),  
                        start: date,  
                        allDay: true,  
                        color: typeColors[type] || '#808080',  
                        extendedProps: { type, quantity, shift }  
                    });
                }
                saveAndRerender();
                showToast('Calendario aggiornato.');
            }

            function creaRigaTurno(data = {}) {
                const rigaDiv = document.createElement('div');
                rigaDiv.className = 'turno-riga p-3 border rounded-lg bg-gray-50 relative';
                rigaDiv.innerHTML = `<div class="grid grid-cols-4 gap-x-2 items-end"><div><label class="block text-xs font-medium">Data</label><input type="date" value="${data.data || ''}" class="data-turno-input form-input-box mt-1"></div><div><label class="block text-xs font-medium">Numero</label><input type="text" placeholder="Es: 8317" value="${data.numero || ''}" class="numero-turno-input form-input-box mt-1"></div><div><label class="block text-xs font-medium">Inizio</label><input type="time" value="${data.inizio || ''}" class="inizio-turno-input form-input-box mt-1"></div><div><label class="block text-xs font-medium">Fine</label><input type="time" value="${data.fine || ''}" class="fine-turno-input form-input-box mt-1"></div></div><button type="button" class="absolute -top-2 -right-2 bg-white rounded-full text-red-400 hover:text-red-600" title="Rimuovi"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg></button>`;
                rigaDiv.querySelector('button').addEventListener('click', () => rigaDiv.remove());
                turniContainer.appendChild(rigaDiv);
            }
            
            function creaRigaCongedo(data = {}) {
                const rigaDiv = document.createElement('div');
                rigaDiv.className = 'congedo-riga p-3 border rounded-lg bg-gray-50 relative';
                rigaDiv.innerHTML = `<div class="grid grid-cols-3 gap-x-2 items-end"><div><label class="block text-xs font-medium">Data</label><input type="date" value="${data.data || ''}" class="data-congedo-input form-input-box mt-1"></div><div><label class="block text-xs font-medium">Fascia Oraria</label><select class="fascia-congedo-input form-input-box mt-1"><option value="Presto" ${data.fascia === 'Presto' ? 'selected' : ''}>Presto</option><option value="Medio" ${data.fascia === 'Medio' ? 'selected' : ''}>Medio</option><option value="Tardi" ${data.fascia === 'Tardi' ? 'selected' : ''}>Tardi</option></select></div><div><label class="block text-xs font-medium">Quantità</label><input type="number" min="1" value="${data.quantita || '1'}" class="quantita-congedo-input form-input-box mt-1"></div></div><button type="button" class="absolute -top-2 -right-2 bg-white rounded-full text-red-400 hover:text-red-600" title="Rimuovi"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg></button>`;
                rigaDiv.querySelector('button').addEventListener('click', () => rigaDiv.remove());
                congediContainer.appendChild(rigaDiv);
            }

            function salvaTurni(deposito) {
                turniPerDeposito[deposito] = Array.from(turniContainer.querySelectorAll('.turno-riga')).map(riga => ({ data: riga.querySelector('.data-turno-input').value, numero: riga.querySelector('.numero-turno-input').value, inizio: riga.querySelector('.inizio-turno-input').value, fine: riga.querySelector('.fine-turno-input').value, }));
            }
            function salvaCongedi() {
                congediDaOffrire = Array.from(congediContainer.querySelectorAll('.congedo-riga')).map(riga => ({ data: riga.querySelector('.data-congedo-input').value, fascia: riga.querySelector('.fascia-congedo-input').value, quantita: riga.querySelector('.quantita-congedo-input').value, }));
            }
            function caricaTurni(deposito) {
                turniContainer.innerHTML = '';
                const turniSalvati = turniPerDeposito[deposito] || [];
                turniSalvati.forEach(turno => creaRigaTurno(turno));
            }

            function generateMonthlyReportData() {
                const formatDate = (d) => d.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
                
                const needIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="${typeColors.need}"/><line x1="15" y1="9" x2="9" y2="15" stroke="white" stroke-width="3"/><line x1="9" y1="9" x2="15" y2="15" stroke="white" stroke-width="3"/></svg>`;
                const leaveIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="${typeColors.leave}"/><path d="M20 6L9 17l-5-5" stroke="white" stroke-width="3" fill="none"/></svg>`;
                const availabilityIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="${typeColors.availability}"/><path d="M20 6L9 17l-5-5" stroke="white" stroke-width="3" fill="none"/></svg>`;

                const currentCalendarDate = calendar.getDate();
                const firstDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
                const lastDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0);
                const filteredEvents = calendarEvents.filter(event => { const d=new Date(event.start); return d.getFullYear()===firstDate.getFullYear() && d.getMonth()===firstDate.getMonth(); });
                
                let mainTableHtml = '';
                if(filteredEvents.length===0){ mainTableHtml = `<div style="text-align:center; padding:20px;">Nessun evento per il mese selezionato.</div>`; }
                else {
                    const groupedData={};
                    filteredEvents.forEach(event=>{
                        const date=event.start.split('T')[0];
                        if(!groupedData[date]){ groupedData[date] = {needs:{early:0,medium:0,late:0},leaves:{early:0,medium:0,late:0}, availabilities:{early:0,medium:0,late:0}}; }
                        const p=event.extendedProps;
                        if(p.type==='need'){ groupedData[date].needs[p.shift]+=p.quantity; }
                        else if(p.type==='leave'){ groupedData[date].leaves[p.shift]+=p.quantity; }
                        else if(p.type==='availability'){ groupedData[date].availabilities[p.shift]+=p.quantity; }
                    });

                    const sortedDates=Object.keys(groupedData).sort((a,b)=>new Date(a)-new Date(b));
                    mainTableHtml = `<table style="width:100%; border-collapse: collapse; font-size: 14px;"><thead><tr style="background-color: #e0e0e0; font-weight: bold;"><th style="padding: 8px; border: 1px solid #999; text-align: left;">Data</th><th style="padding: 8px; border: 1px solid #999; width: 40px;"></th><th style="padding: 8px; border: 1px solid #999; text-align: left;">Dettaglio</th></tr></thead><tbody>`;
                    const shiftSingular = {early:'Presto',medium:'Medio',late:'Tardi'};
                    const shiftPlural = {early:'Presti',medium:'Medi',late:'Tardi'};
                    const iconCellStyle = "padding: 8px; border: 1px solid #ccc; vertical-align: middle; text-align: center;";
                    
                    for(const dateStr of sortedDates){
                        const data = groupedData[dateStr];
                        const date = new Date(dateStr+'T00:00:00');
                        
                        const needParts = Object.entries(data.needs).filter(([,q])=>q>0).map(([k,v])=>`${v} ${v > 1 ? shiftPlural[k] : shiftSingular[k]}`);
                        const leaveParts = Object.entries(data.leaves).filter(([,q])=>q>0).map(([k,v])=>`${v} ${v > 1 ? shiftPlural[k] : shiftSingular[k]}`);
                        const availabilityParts = Object.entries(data.availabilities).filter(([,q])=>q>0).map(([k,v])=>`${v} ${v > 1 ? shiftPlural[k] : shiftSingular[k]}`);

                        const rowsForDate = [];
                        if (needParts.length > 0) rowsForDate.push({ icon: needIcon, text: `Turni da coprire: ${needParts.join(' + ')}` });
                        if (leaveParts.length > 0) rowsForDate.push({ icon: leaveIcon, text: `Congedi disponibili: ${leaveParts.join(' + ')}` });
                        if (availabilityParts.length > 0) rowsForDate.push({ icon: availabilityIcon, text: `Disponibilità: ${availabilityParts.join(' + ')}` });

                        if (rowsForDate.length > 0) {
                            const rowspan = rowsForDate.length > 1 ? `rowspan="${rowsForDate.length}"` : '';
                            mainTableHtml += `<tr class="page-break-avoid"><td ${rowspan} style="vertical-align: middle; padding: 8px; border: 1px solid #ccc;">${formatDate(date)}</td><td style="${iconCellStyle}">${rowsForDate[0].icon}</td><td style="padding: 8px; border: 1px solid #ccc;">${rowsForDate[0].text}</td></tr>`;
                            for (let i = 1; i < rowsForDate.length; i++) {
                                mainTableHtml += `<tr class="page-break-avoid"><td style="${iconCellStyle}">${rowsForDate[i].icon}</td><td style="padding: 8px; border: 1px solid #ccc;">${rowsForDate[i].text}</td></tr>`;
                            }
                        }
                    }
                    mainTableHtml += `</tbody></table>`;
                }

                const stats = { approved: parseInt(statsAcceptedInput.value,10)||0, pending: parseInt(statsPendingInput.value,10)||0, rejected: parseInt(statsRejectedInput.value,10)||0 };
                const totalRequests = stats.approved + stats.pending + stats.rejected;
                let statsHtmlBlock = '';

                if (totalRequests > 0) {
                    const percApproved = ((stats.approved / totalRequests) * 100).toFixed(0);
                    const percPending = ((stats.pending / totalRequests) * 100).toFixed(0);
                    const percRejected = ((stats.rejected / totalRequests) * 100).toFixed(0);
                    statsHtmlBlock = `
                        <div style="margin-top: 20px; width: 100%;">
                            <div style="width: 60%; margin: 0 auto;">
                                <p style="font-weight: bold; margin-bottom: 5px; font-size: 12px;">Stato delle richieste dal personale</p>
                                <table class="summary-table">
                                    <thead style="background-color:#e0e0e0;">
                                        <tr><th>Totale</th><th>Accettate</th><th>Respinte</th><th>In sospeso</th></tr>
                                    </thead>
                                    <tbody>
                                        <tr><td>${totalRequests}</td><td>${stats.approved}</td><td>${stats.rejected}</td><td>${stats.pending}</td></tr>
                                        <tr><td>100%</td><td>${percApproved}%</td><td>${percRejected}%</td><td>${percPending}%</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>`;
                }
                
                let fullHtml = `<div id="pdf-content" style="font-family: Arial, sans-serif; color: #000; border: 1px solid #000; padding: 20px; display: flex; flex-direction: column; min-height: 98%;">
                    <style>
                        .summary-table { border-collapse: collapse; width: 100%; font-size: 11px; }  
                        .summary-table th, .summary-table td { border: 1px solid black; padding: 4px; text-align: center; }  
                        .page-break-avoid { page-break-inside: avoid !important; }
                    </style>
                    <div>
                        <h2 style="text-align:center;font-size:20px;font-weight:bold;margin:0 0 20px 0;">Stato degli effettivi: dal ${formatDate(firstDate)} al ${formatDate(lastDate)}</h2>
                        <table style="width:100%;margin-bottom:20px;font-size:14px;border:none;">
                            <tr>
                                <td style="border:none;padding:2px;"><strong>Deposito:</strong> ${document.getElementById('deposito').value}</td>
                                <td style="border:none;padding:2px;text-align:right;"><strong>Mancanza di personale =</strong> <span style="display:inline-block; vertical-align:middle;">${needIcon}</span></td>
                            </tr>
                            <tr>
                                <td style="border:none;padding:2px;"><strong>Situazione al:</strong> ${new Date().toLocaleDateString('it-IT', { timeZone: 'Europe/Zurich' })}</td>
                                <td style="border:none;padding:2px;text-align:right;"><strong>Disponibilità di congedi =</strong> <span style="display:inline-block; vertical-align:middle;">${leaveIcon}</span></td>
                            </tr>
                            <tr>
                                <td style="border:none;padding:2px;"></td>
                                <td style="border:none;padding:2px;text-align:right;"><strong>Disponibilità di personale =</strong> <span style="display:inline-block; vertical-align:middle;">${availabilityIcon}</span></td>
                            </tr>
                        </table>
                    </div>
                    <div style="flex-grow: 1;">${mainTableHtml}</div>
                    <div class="page-break-avoid">
                        ${statsHtmlBlock}
                        <p style="margin-top:15px;"><strong>Particolarità del mese:</strong> ${document.getElementById('particolarita').value}</p>
                        <p style="margin-top:15px;font-size:12px;">Se desiderate prendere un giorno di congedo o dare la vostra disponibilità, anche in cambio di un congedo, siete pregati di inserire la richiesta in Sopre.<br>Eventualmente contattare: Distributore mensile, +41 51 285 11 11.</p>
                        <p style="font-size:12px;">Vi ringraziamo per la vostra collaborazione.</p>
                    </div>
                </div>`;
                return { html: fullHtml };
            }

            function openModal(reportGenerator, title) {
                try {
                    const reportData = reportGenerator();
                    if (!reportData) return;
                    currentReportGenerator = reportGenerator;
                    reportModalTitle.textContent = title;
                    reportContent.innerHTML = reportData.html;
                    reportModal.classList.remove('hidden');
                    // Add a class to body to prevent scrolling when modal is open
                    document.body.classList.add('overflow-hidden');

                    // If it's the "Turni Organizzati" report, show the specific email button
                    if (title === 'Turni Organizzati per Fascia Oraria') {
                        document.getElementById('sendEmailBtn').classList.add('hidden'); // Hide the general email button
                        document.getElementById('generateSelectedShiftsEmailBtn').classList.remove('hidden');
                        // Add event listeners to the new checkboxes within the modal AFTER it's rendered
                        document.querySelectorAll('#reportModal .shift-select-checkbox').forEach(checkbox => {
                            checkbox.addEventListener('change', updateGenerateSelectedShiftsButtonState);
                        });

                        document.querySelectorAll('#reportModal .macchinista-select-all-checkbox').forEach(masterCheckbox => {
                            masterCheckbox.addEventListener('change', function() {
                                const macchinistaId = this.dataset.macchinistaId;
                                const isChecked = this.checked;
                                document.querySelectorAll(`#reportModal .shift-select-checkbox[data-macchinista-id="${macchinistaId}"]`).forEach(shiftCheckbox => {
                                    shiftCheckbox.checked = isChecked;
                                });
                                updateGenerateSelectedShiftsButtonState();
                            });
                        });
                        updateGenerateSelectedShiftsButtonState(); // Ensure its state is correct on open
                    } else {
                        document.getElementById('sendEmailBtn').classList.remove('hidden'); // Show the general email button for other reports
                        document.getElementById('generateSelectedShiftsEmailBtn').classList.add('hidden');
                    }

                } catch (error) {  
                    console.error("ERRORE in openModal:", error);  
                    showToast(`Errore nell'apertura del report: ${error.message}.`);  
                    reportModal.classList.add('hidden');  
                    document.body.classList.remove('overflow-hidden');  
                }
            }

            function closeModal() {  
                reportModal.classList.add('hidden');  
                document.body.classList.remove('overflow-hidden');  
                // Hide the specific email button when any modal is closed
                document.getElementById('generateSelectedShiftsEmailBtn').classList.add('hidden');
                // Ensure the general send email button is visible for next time (unless it's the special report)
                document.getElementById('sendEmailBtn').classList.remove('hidden');  
                // Ensure the selection state is cleared visually when the modal closes
                if (reportModalTitle.textContent === 'Turni Organizzati per Fascia Oraria') {
                    document.querySelectorAll('.shift-select-checkbox').forEach(cb => cb.checked = false);
                    document.querySelectorAll('.macchinista-select-all-checkbox').forEach(cb => cb.checked = false);
                    // No need to call updateGenerateSelectedShiftsButtonState here as the button will be hidden
                }
            }

            function generateUnifiedAnnouncementData() {
                salvaTurni(depositoReportSelect.value);
                salvaCongedi();

                const startDateVal = document.getElementById('startDate').value;
                const endDateVal = document.getElementById('endDate').value;

                if (!startDateVal || !endDateVal) {
                    showToast("Per favore, imposta un intervallo di date (Da/A).");
                    return null;
                }

                const startDate = new Date(startDateVal + 'T00:00:00');
                const endDate = new Date(endDateVal + 'T23:59:59');
                const formatDate = (dateStr) => new Date(dateStr+'T00:00:00').toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
                
                let turniHtml = '';
                let hasTurni = false;

                for (const deposito in turniPerDeposito) {
                    if (turniPerDeposito.hasOwnProperty(deposito) && turniPerDeposito[deposito].length > 0) {
                        const turniFiltrati = turniPerDeposito[deposito]
                            .filter(t => {
                                if (!t.data) return false;
                                const turnoDate = new Date(t.data + 'T00:00:00');
                                return turnoDate >= startDate && turnoDate <= endDate;
                            })
                            .sort((a, b) => new Date(a.data) - new Date(b.data));

                        if (turniFiltrati.length > 0) {
                            hasTurni = true;
                            turniHtml += `<h3 style="font-size: 16px; font-weight: bold; color: #1e3a8a; margin-top: 20px; margin-bottom: 10px; border-bottom: 2px solid #e5e7eb; padding-bottom: 5px;">Turni da coprire - ${deposito}</h3>`;
                            turniHtml += `<table style="width: 100%; border-collapse: collapse; font-size: 14px;"><thead style="text-align: left; background-color: #eff6ff;"><tr><th style="padding: 8px;">Data</th><th style="padding: 8px;">Numero</th><th style="padding: 8px;">Inizio</th><th style="padding: 8px;">Fine</th></tr></thead><tbody>`;
                            turniFiltrati.forEach(t => {
                                turniHtml += `<tr style="border-bottom: 1px solid #e5e7eb;"><td style="padding: 8px;">${formatDate(t.data)}</td><td style="padding: 8px;">${t.numero || ''}</td><td style="padding: 8px;">${t.inizio || ''}</td><td style="padding: 8px;">${t.fine || ''}</td></tr>`;
                            });
                            turniHtml += `</tbody></table>`;
                        }
                    }
                }
                if (!hasTurni) {
                    turniHtml = `<h3 style="font-size: 16px; font-weight: bold; color: #1e3a8a; margin-top: 20px; margin-bottom: 10px; border-bottom: 2px solid #e5e7eb; padding-bottom: 5px;">Turni da coprire</h3><p style="margin-top: 10px; font-style: italic;">Nessun turno da coprire per il periodo selezionato.</p>`;
                }

                let congediHtml = `<h3 style="font-size: 16px; font-weight: bold; color: #059669; margin-top: 20px; margin-bottom: 10px; border-bottom: 2px solid #e5e7eb; padding-bottom: 5px;">Congedi da offrire</h3>`;
                const congediFiltrati = congediDaOffrire
                    .filter(c => {
                        if (!c.data) return false;
                        const congedoDate = new Date(c.data + 'T00:00:00');
                        return congedoDate >= startDate && congedoDate <= endDate;
                    })
                    .sort((a, b) => new Date(a.data) - new Date(b.data));

                if (congediFiltrati.length > 0) {
                    congediHtml += `<table style="width: 100%; border-collapse: collapse; font-size: 14px;"><thead style="text-align: left; background-color: #f0fdfa;"><tr><th style="padding: 8px;">Data</th><th style="padding: 8px;">Fascia Oraria</th><th style="padding: 8px;">Quantità</th></tr></thead><tbody>`;
                    congediFiltrati.forEach(c => {
                        congediHtml += `<tr style="border-bottom: 1px solid #e5e7eb;"><td style="padding: 8px;">${formatDate(c.data)}</td><td style="padding: 8px;">${c.fascia || ''}</td><td style="padding: 8px;">${c.quantita || ''}</td></tr>`;
                    });
                    congediHtml += `</tbody></table>`;
                } else {
                    congediHtml += `<p style="margin-top: 10px; font-style: italic;">Nessun congedo da offrire per il periodo selezionato.</p>`;
                }

                const fullHtml = `
                    <div id="pdf-content" style="font-family: Arial, sans-serif; color: #333;">
                        <h2 style="text-align:center;font-size:20px;font-weight:bold;margin:0 0 10px 0;">Annuncio Stato Effettivi</h2>
                        <p style="text-align:center; font-size: 16px; margin-bottom: 20px; color: #555;">
                            Periodo: <strong>${formatDate(startDateVal)}</strong> - <strong>${formatDate(endDateVal)}</strong>
                        </p>
                        ${turniHtml}
                        ${congediHtml}
                        <p style="margin-top:30px; font-size:12px;">Se interessati, siete pregati di inserire la richiesta in Sopre o contattare la ripartizione del personale.</p>
                        <p style="font-size:12px;">Grazie per la collaborazione.</p>
                    </div>`;

                return { html: fullHtml };
            }

            // --- PDF DOWNLOAD FUNCTION ---
            downloadPdfBtn.addEventListener('click', async function() {
                const reportElement = document.getElementById('reportContent');
                if (!reportElement || reportElement.innerHTML.trim() === '') {
                    showToast('Nessun report da scaricare. Genera prima un report.');
                    return;
                }

                const filename = reportModalTitle.textContent.replace(/[^a-z0-9]/gi, '_').toLowerCase() + '.pdf';

                try {
                    // Temporarily hide elements that might interfere with PDF generation if needed
                    // For example, if there are interactive elements or buttons within reportContent
                    // reportElement.querySelectorAll('button, input[type="checkbox"]').forEach(el => el.style.display = 'none');

                    const options = {
                        margin: 10,
                        filename: filename,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2, useCORS: true },
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }, // <-- MODIFICA EFFETTUATA QUI
                        pagebreak: { avoid: '.page-break-avoid' }
                    };

                    await html2pdf().set(options).from(reportElement).save();
                    showToast('PDF scaricato con successo!');

                } catch (error) {
                    console.error('Errore durante la generazione del PDF:', error);
                    showToast('Errore durante il download del PDF.');
                } finally {
                    // Restore hidden elements if they were hidden
                    // reportElement.querySelectorAll('button, input[type="checkbox"]').forEach(el => el.style.display = '');
                }
            });


            // --- LISTENERS GENERALI ---
            generateReportBtn.addEventListener('click', () => openModal(generateMonthlyReportData, 'Report Stato Effettivi Mensile'));
            generateShortReportBtn.addEventListener('click', () => openModal(generateUnifiedAnnouncementData, 'Annuncio Stato Effettivi'));
            closeModalBtn.addEventListener('click', closeModal);  
            openNewTabBtn.addEventListener('click', () => {  
                if (!currentReportGenerator) return;  
                const reportData = currentReportGenerator();  
                if(!reportData) return;  
                const newWindow = window.open();  
                newWindow.document.write(`<html><head><title>${reportModalTitle.textContent}</title></head><body>${reportData.html}</body></html>`);  
                newWindow.document.close();  
            });
            copyHtmlBtn.addEventListener('click', () => {  
                const reportHtmlElement = document.getElementById('pdf-content');  
                if(!reportHtmlElement) { showToast('Contenuto del report non trovato.'); return; }
                navigator.clipboard.writeText(reportHtmlElement.outerHTML).then(
                    () => showToast('Codice HTML copiato!'),  
                    () => showToast('Erro durante la copia.')
                );  
            });
            // Original Send Email button for general reports
            sendEmailBtn.addEventListener('click', function() {  
                const subject = encodeURIComponent(reportModalTitle.textContent || "Report Effettivi");  
                const body = encodeURIComponent("Buongiorno,\n\nIn allegato il report richiesto.\n\nCordiali saluti.");  
                window.location.href = `mailto:?subject=${subject}&body=${body}`;  
            });


            // Listeners per Pane 1 (Calendario)
            entryForm.addEventListener('submit', function(e) {  
                e.preventDefault();  
                const formData = new FormData(entryForm);  
                addOrUpdateCalendarEvent(  
                    formData.get('entryDate'),  
                    formData.get('entryType'),  
                    formData.get('shiftType'),  
                    parseInt(formData.get('quantity'), 10)  
                );  
            });
            modalEntryForm.addEventListener('submit', function(e) {  
                e.preventDefault();  
                const formData = new FormData(modalEntryForm);  
                addOrUpdateCalendarEvent(  
                    formData.get('entryDate'),  
                    formData.get('entryType'),  
                    formData.get('shiftType'),  
                    parseInt(formData.get('quantity'), 10)  
                );  
                addEventModal.classList.add('hidden');  
            });
            closeAddEventModalBtn.addEventListener('click', () => addEventModal.classList.add('hidden'));
            
            // Listeners per Pane 2 (Annuncio Effettivi)
            depositoReportSelect.addEventListener('change', (e) => {  
                salvaTurni(depositoPrecedente);  
                const nd=e.target.value;  
                caricaTurni(nd);  
                depositoPrecedente=nd;  
            });
            addTurnoBtn.addEventListener('click', () => creaRigaTurno());
            addCongedoBtn.addEventListener('click', () => creaRigaCongedo());
            
            clearAllBtn.addEventListener('click', function() {
                if (confirm("Sei sicuro di voler pulire tutti i dati per l'annuncio? Questa operazione non può essere annullata e non influisce sul calendario.")) {
                    try {
                        document.getElementById('startDate').value = '';
                        document.getElementById('endDate').value = '';
                        document.getElementById('quick-add-turno').value = '';
                        Object.keys(turniPerDeposito).forEach(key => delete turniPerDeposito[key]);
                        congediDaOffrire.length = 0;
                        turniContainer.innerHTML = '';
                        congediContainer.innerHTML = '';
                        showToast('I dati per l\'annuncio sono stati puliti.');
                    } catch (e) { console.error("Errore durante la pulizia dei dati annuncio:", e); showToast("Si è verificato un errore imprevisto."); }
                }
            });

            quickAddBtn.addEventListener('click', function() {
                const text = quickAddTurnoInput.value;
                if (!text.trim()) { showToast('Incolla del testo prima di aggiungere.'); return; }
                const columns = text.split(/\s{2,}|\t/).filter(Boolean);  
                
                const dateRegex = /(\d{2}\.\d{2}\.\d{4})/;
                const timeRegex = /(\d{1,2}:\d{2})/;
                const numberRegex = /(\d{3,4})/;  
                
                let dateStr = null;
                let numero = null;
                let inizio = null;
                let fine = null;
                let foundTimes = [];

                for(let i = 0; i < columns.length; i++) {
                    const col = columns[i].trim();
                    if (dateRegex.test(col) && !dateStr) {
                        dateStr = col;
                    } else if (numberRegex.test(col) && !numero && !timeRegex.test(col) && col.length >= 3 && col.length <= 4) {  
                        numero = col;
                    } else if (timeRegex.test(col)) {
                        foundTimes.push(col);
                    }
                }

                if (foundTimes.length >= 1) inizio = foundTimes[0];
                if (foundTimes.length >= 2) fine = foundTimes[1];

                if (!dateStr || !numero || !inizio || !fine) {
                    showToast('Formato testo non valido. Impossibile estrarre data, numero o orari.');
                    return;
                }

                const dateParts = dateStr.split('.');
                if (dateParts.length !== 3) { showToast('Formato data non valido (gg.mm.aaaa).'); return; }
                const formattedDate = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;  

                let depotName = document.getElementById('depositoReport').value;  
                const depotMap = { 'CHI': 'Chiasso P', 'BEL': 'Bellinzona P' };
                for (const col of columns) {
                    if (depotMap[col]) {
                        depotName = depotMap[col];
                        break;
                    }
                }

                if (depositoReportSelect.value !== depotName) {
                    depositoReportSelect.value = depotName;
                    depositoReportSelect.dispatchEvent(new Event('change'));  
                    setTimeout(() => { creaRigaTurno({ data: formattedDate, numero, inizio, fine }); }, 100);
                } else {
                    creaRigaTurno({ data: formattedDate, numero, inizio, fine });
                }
                quickAddTurnoInput.value = '';
                showToast(`Turno ${numero} aggiunto a ${depotName}!`);
            });

            // Listeners per Pane 3 (Statistiche e Analisi)
            analyzeBtn.addEventListener('click', function() {  
                const text = pasteArea.value;  
                if (!text.trim()) { showToast('Incolla il testo da analizzare.'); return; }  
                let accepted = 0, pending = 0, rejected = 0;  
                const targetTypes = ['CTV', 'CTS', 'TRP', 'RTV', 'ND2', 'ND3'];  
                const lines = text.trim().split('\n');  
                const records = [];  
                let currentRecordLines = [];  
                lines.forEach((line, index) => {  
                    const isNewRecordStart = /\b\d{5,6}\b/.test(line) && index > 0;  
                    if (isNewRecordStart && currentRecordLines.length > 0) {  
                        records.push(currentRecordLines.join(' '));  
                        currentRecordLines = [];  
                    }  
                    currentRecordLines.push(line);  
                });  
                if (currentRecordLines.length > 0) {  
                    records.push(currentRecordLines.join(' '));  
                }  
                records.forEach(record => {  
                    const hasTargetType = targetTypes.some(type => new RegExp(`\\b${type}\\b`, 'i').test(record));  
                    if (hasTargetType) {  
                        const recordLC = record.toLowerCase();  
                        if (recordLC.includes('annullato')) { }  
                        else if (recordLC.includes('accordato')) { accepted++; }  
                        else if (recordLC.includes('in lavorazione') || recordLC.includes('aperto')) { pending++; }  
                        else if (recordLC.includes('respinto') || recordLC.includes('rifiutato')) { rejected++; }  
                    }  
                });  
                statsAcceptedInput.value = accepted;  
                statsPendingInput.value = pending;  
                statsRejectedInput.value = rejected;  
                showToast(`Analisi completata: ${accepted} Accettate, ${pending} in Sospeso, ${rejected} Respinte.`);  
            });
            
            // --- LOGICA PER ATTESA TURNO (PANE 5) ---
            processStandbyBtn.addEventListener('click', function() {  
                const text = standbyPasteArea.value;  
                if (!text.trim()) {  
                    showToast('Incolla il testo da elaborare.');  
                    return;  
                }  
                standbyResultsContainer.innerHTML = '';  
                const lines = text.trim().split('\n');  
                
                lines.forEach(line => {  
                    if (line.trim().length === 0) return;  
                    const dateMatch = line.match(/(\d{2}\.\d{2}\.\d{4})/);  
                    const nameSurnameMatricolaMatch = line.match(/([A-Z][a-zÀ-ÿ']+(?:\s+[A-Z][a-zÀ-ÿ']+){0,2})\s+(\d{6})/);  
                    
                    if (dateMatch && nameSurnameMatricolaMatch) {  
                        const date = dateMatch[1];  
                        const fullName = nameSurnameMatricolaMatch[1];
                        const nameParts = fullName.split(/\s+/).filter(Boolean);  
                        const surname = nameParts[0];
                        const name = nameParts.slice(1).join(' ');  
                        const matricola = nameSurnameMatricolaMatch[2];

                        const normalizeForEmail = (str) => str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f\s\.]/g, '');  
                        const emailAddress = `${normalizeForEmail(name)}.${normalizeForEmail(surname)}@sbb.ch`;  
                        
                        const subject = `Assegnazione turno del ${date}`;
                        const emailBody = `Buongiorno ${name},

vi scriviamo per informarti che l’assegnazione del turno previsto per il giorno ${date} verrà effettuata il giorno precedente, al fine di garantire una prestazione lavorativa da parte nostra, tenuto conto della situazione di esubero di personale prevista per quella data.
Ringraziandovi per l'attenzione, porgiamo cordiali saluti.

Ripartizione del Personale
P-O-BP-ZFR-MSD-EIN
Ferrovie Federali Svizzere – FFS
Produzione ferroviaria – Condotta dei treni e manovra
6500 Bellinzona
`;
                        const resultDiv = document.createElement('div');  
                        resultDiv.className = 'p-2 border rounded-lg bg-gray-50 flex justify-between items-center';  
                        resultDiv.innerHTML = `<span class="text-sm">${surname} ${name} (${matricola}) - ${date}</span><button class="send-standby-email-btn px-3 py-1 bg-teal-600 text-white text-sm rounded-md hover:bg-teal-700" data-email="${emailAddress}" data-subject="${encodeURIComponent(subject)}" data-body="${encodeURIComponent(emailBody)}">Invia Email</button>`;  
                        standbyResultsContainer.appendChild(resultDiv);  
                    } else {
                        console.warn('Skipping malformed or unrecognized standby line:', line);
                        showToast(`Errore parsing riga attesa: "${line.substring(0, Math.min(line.length, 50))}..."`);
                    }
                });  
                standbyPasteArea.value = '';  
                if(standbyResultsContainer.children.length > 0){  
                    showToast('Lista elaborata!');  
                } else {  
                    showToast('Nessun dato valido trovato nel testo.');  
                }  
            });
            standbyResultsContainer.addEventListener('click', function(e){ if(e.target.classList.contains('send-standby-email-btn')) { const button = e.target; const email = button.dataset.email; const subject = button.dataset.subject; const body = button.dataset.body; window.location.href = `mailto:${email}?subject=${subject}&body=${body}`; } });

            // --- LOGICA PER GESTIONE CAMBI (PANE 4) ---
            const swapBlocksContainer = document.getElementById('swap-blocks-container');

            function createSwapBlockHTML() {
                return `
                <div class="change-block border p-4 rounded-lg bg-white shadow-sm space-y-3 relative">
                    <button class="remove-change-block-btn absolute -top-2 -right-2 bg-red-500 text-white rounded-full h-7 w-7 flex items-center justify-center shadow-md hover:bg-red-600 font-bold text-lg">&times;</button>
                    
                    <h3 class="font-semibold text-lg text-gray-800 border-b pb-2">Gestione Cambio Macchinista</h3>
                    
                    <div>
                        <label class="text-sm font-medium text-gray-700">Dati Macchinista</label>
                        <div class="flex gap-2 mt-1">
                            <textarea class="parser-input form-input-box w-full" rows="2" placeholder="Incolla dati: Cognome Nome Matricola..."></textarea>
                            <button data-type="driver" class="process-paste-btn px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 self-center">Elabora</button>
                        </div>
                        <div class="driver-info parsed-info p-2 mt-2 rounded-md text-sm"></div>
                    </div>
                    
                    <div>
                        <label class="text-sm font-medium text-gray-700">Turno Originale (da stornare)</label>
                        <div class="flex gap-2 mt-1">
                            <textarea class="parser-input form-input-box w-full" rows="2" placeholder="Incolla riga turno originale..."></textarea>
                            <button data-type="shift" class="process-paste-btn px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 self-center">Elabora</button>
                        </div>
                        <div class="shift-original-info parsed-info p-2 mt-2 rounded-md text-sm"></div>
                    </div>
                    
                    <div>
                        <label class="text-sm font-medium text-gray-700">Motivo dello storno</label>
                        <input type="text" class="motivo-input form-input-box w-full mt-1" placeholder="Es: Necessità di servizio, cambio programma...">
                    </div>

                    <div>
                        <label class="text-sm font-medium text-gray-700">Turno Nuovo (da assegnare)</label>
                        <div class="flex gap-2 mt-1">
                            <textarea class="parser-input form-input-box w-full" rows="2" placeholder="Incolla riga turno nuovo..."></textarea>
                            <button data-type="shift" class="process-paste-btn px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 self-center">Elabora</button>
                        </div>
                        <div class="shift-new-info parsed-info p-2 mt-2 rounded-md text-sm"></div>
                    </div>
                    
                    <div class="pt-2">
                        <button class="generate-change-email-btn w-full flex justify-center items-center py-2 px-4 border rounded-lg text-white bg-green-600 hover:bg-green-700 font-semibold">Genera Email di Avviso</button>
                    </div>
                </div>`;
            }
            
            function addNewChangeBlock() {
                const blockHTML = createSwapBlockHTML();
                swapBlocksContainer.insertAdjacentHTML('beforeend', blockHTML);
            }
            
            document.getElementById('add-new-swap-block-btn').addEventListener('click', addNewChangeBlock);
            // Add one block by default on load for Gestione Cambi
            addNewChangeBlock();


            function parseDriverInfo(text) {
                const match = text.match(/\b([A-Z][a-zÀ-ÿ']+)\s+([A-Z][a-zÀ-ÿ']+)\s+(\d{6})/);
                if (match) {
                    const surname = match[1];
                    const name = match[2];
                    const matricola = match[3];
                    const normalize = (str) => str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s/g, '');
                    const email = `${normalize(name)}.${normalize(surname)}@sbb.ch`;
                    return { name, surname, matricola, email };
                }
                return null;
            }

            function parseShiftInfo(text) {
                const columns = text.split(/\s{2,}|\t/).filter(Boolean);
                if (columns.length < 4) return null;

                const dateMatch = columns[0].match(/(\d{2}\.\d{2}\.\d{4})/);
                const date = dateMatch ? dateMatch[1] : null;
                const number = columns[1] || null;
                const depot = columns.find(c => c === 'BEL' || c === 'CHI') || null;
                const times = columns.filter(c => /^\d{1,2}:\d{2}$/.test(c.trim()));
                const start = times.length > 0 ? times[0] : null;
                
                const startIndex = columns.findIndex(c => c.trim() === start);
                let end = null;
                if(startIndex > -1 && columns.length > startIndex + 1 && /^\d{1,2}:\d{2}$/.test(columns[startIndex+1].trim())){
                    end = columns[startIndex + 1].trim();
                } else if (times.length > 1) {
                    end = times[1];  
                }

                if (date && number && depot && start && end) {
                    return { date, number, depot, start, end };
                }
                return null;
            }
            
            swapBlocksContainer.addEventListener('click', function(e) {
                const button = e.target.closest('button');
                if (!button) return;

                const parentBlock = e.target.closest('.change-block');
                if (!parentBlock) return;

                // Handle Remove Button
                if (button.classList.contains('remove-change-block-btn')) {
                    if (confirm('Sei sicuro di voler rimuovere questo blocco?')) {
                        parentBlock.remove();
                    }
                    return;
                }

                // Handle Process Button
                if (button.classList.contains('process-paste-btn')) {
                    const type = button.dataset.type;
                    const textarea = button.previousElementSibling;
                    const text = textarea.value;
                    const infoDiv = textarea.parentElement.nextElementSibling;
                    
                    if (!text.trim()) {
                        showToast("Incolla del testo prima di elaborare.");
                        return;
                    }

                    let parsedData = null;
                    let displayText = '<p class="text-red-500">Dati non validi o formato non riconosciuto.</p>';

                    if (type === 'driver') {
                        parsedData = parseDriverInfo(text);
                        if (parsedData) {
                            displayText = `<strong>Macch:</strong> ${parsedData.surname} ${parsedData.name} (${parsedData.matricola})<br><strong>Email:</strong> ${parsedData.email}`;
                        }
                    } else if (type === 'shift') {
                        parsedData = parseShiftInfo(text);
                            if (parsedData) {
                            displayText = `<strong>Turno:</strong> ${parsedData.number} del ${parsedData.date}<br><strong>Orario:</strong> ${parsedData.start} - ${parsedData.end} (${parsedData.depot})`;
                        }
                    }
                    
                    infoDiv.innerHTML = displayText;
                    if (parsedData) {
                        infoDiv.dataset.parsed = JSON.stringify(parsedData);
                        infoDiv.classList.remove('invalid');
                        infoDiv.classList.add('valid');
                    } else {
                            delete infoDiv.dataset.parsed;
                            infoDiv.classList.remove('valid');
                            infoDiv.classList.add('invalid');
                    }
                    return;
                }

                // Handle Generate Email Button
                if (button.classList.contains('generate-change-email-btn')) {
                    const driverInfoDiv = parentBlock.querySelector('.driver-info');
                    const originalShiftInfoDiv = parentBlock.querySelector('.shift-original-info');
                    const newShiftInfoDiv = parentBlock.querySelector('.shift-new-info');
                    const motivoInput = parentBlock.querySelector('.motivo-input');

                    const allDivs = [driverInfoDiv, originalShiftInfoDiv, newShiftInfoDiv];
                    let allValid = true;

                    allDivs.forEach(div => {
                        if (!div.dataset.parsed) {
                            div.classList.add('invalid');
                            allValid = false;
                        } else {
                            div.classList.remove('invalid');
                        }
                    });
                    
                    let motivo = motivoInput.value.trim();
                    if(!motivo){
                        motivo = "necessità"; // Default reason
                    }

                    if (!allValid) {
                        showToast("Elaborare correttamente tutti i campi prima di generare l'email.");
                        return;
                    }

                    const driver = JSON.parse(driverInfoDiv.dataset.parsed);
                    const s_orig = JSON.parse(originalShiftInfoDiv.dataset.parsed);
                    const s_new = JSON.parse(newShiftInfoDiv.dataset.parsed);

                    const subject = `Modifica piano di servizio del ${s_orig.date}`;
                    
                    const body = `Buongiorno ${driver.name},

la informiamo che è stata apportata una modifica al suo piano di servizio.
Il turno n. ${s_orig.number} previsto per il giorno ${s_orig.date}, con orario ${s_orig.start} – ${s_orig.end}, è stato stornato per motivi di ${motivo}.
In sostituzione, le è stato assegnato il turno n. ${s_new.number}, con data ${s_new.date} e orario ${s_new.start} – ${s_new.end}.

La preghiamo di prenderne nota.

Cordiali saluti,

Ripartizione del Personale
P-O-BP-ZFR-MSD-EIN
Ferrovie Federali Svizzere – FFS
Produzione ferroviaria – Condotta dei treni e manovra
6500 Bellinzona
`;

                    window.location.href = `mailto:${driver.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                }
            });

            // --- LOGICA PER NUOVO PANELLO: CAMBIO FASCIA ORARIA (PANE 6) ---
            const shiftDataPasteAreaForFascia = document.getElementById('shift-data-paste-area');
            const processShiftDataBtnForFascia = document.getElementById('process-shift-data-btn');
            const fasciaCambiPropostiContainer = document.getElementById('fascia-cambi-proposti-container');
            const generateSelectedShiftsEmailBtn = document.getElementById('generateSelectedShiftsEmailBtn');


            function calculateFascia(startTime, endTime) {
                const parseTime = (timeStr) => {
                    const [hours, minutes] = timeStr.split(':').map(Number);
                    const date = new Date(2000, 0, 1);  
                    date.setHours(hours, minutes, 0, 0);
                    return date;
                };

                const start = parseTime(startTime);
                let end = parseTime(endTime);

                if (end.getTime() < start.getTime()) {
                    end.setDate(end.getDate() + 1);  
                }
                
                const F_START_MIN = parseTime('02:00');  
                const F_START_MAX = parseTime('05:59');  
                const F_END_MAX = parseTime('15:00');  

                const M_START_MIN = parseTime('06:00');  
                const M_START_MAX = parseTime('11:59');  
                const M_END_MAX = parseTime('17:00');  

                const T_START_MIN_DAY = parseTime('12:00');  
                const OVERNIGHT_START_MIN = parseTime('00:00');  
                const OVERNIGHT_END_MAX = parseTime('06:00');  

                // Presto: starts between 02:00 and 05:59, ends by 15:00
                if (start >= F_START_MIN && start <= F_START_MAX && end <= F_END_MAX) {
                    return 'Presto';
                }  
                // Medio: starts between 06:00 and 11:59, ends by 17:00
                else if (start >= M_START_MIN && start <= M_START_MAX && end <= M_END_MAX) {
                    return 'Medio';
                }  
                // Tardi: starts from 12:00 onwards OR is a night shift (starts between 00:00 and 01:59 and ends next morning by 06:00)
                // Also handles the `11:48 - 21:11` case from your example which should be Tardi.
                // Refined logic for "Tardi" to correctly classify 11:48-21:11 as Tardi and handle overnight shifts explicitly.
                // A shift is Tardi if:
                // 1. It starts at or after 12:00 (midday)
                // OR
                // 2. It's an overnight shift: starts between 00:00 and 01:59 AND ends after starting time AND ends by 06:00 next day
                // OR
                // 3. It starts between 06:00 and 11:59 (Medio range) but extends beyond the Medio end time (17:00)
                else if (start >= T_START_MIN_DAY ||  
                         (start >= OVERNIGHT_START_MIN && start < F_START_MIN && end.getTime() > start.getTime() && end <= OVERNIGHT_END_MAX) ||
                         (start >= M_START_MIN && start <= M_START_MAX && end.getTime() > M_END_MAX.getTime()))  
                {
                    return 'Tardi';
                }
                
                return 'Sconosciuta';  
            }

            function parseAndOrganizeShiftDataForFascia(text) {
                const lines = text.trim().split('\n');
                const organizedData = {};  

                lines.forEach(line => {
                    try {  
                        // Robust regex:
                        // ^(\S+)\s+(\S+) : Cognome Nome (first two non-whitespace words)
                        // \s+(\d{2}\.\d{2}\.\d{4}) : Date (DD.MM.YYYY)
                        // \s+(\S+) : Shift Number (any non-whitespace characters)
                        // \s+(\d{1,2}:\d{2})\s+(\d{1,2}:\d{2}) : Start Time & End Time (HH:MM)
                        // (?:.*?(\d{6}))? : Optional Matricola (6 digits) anywhere after times
                        const match = line.match(/^(\S+)\s+(\S+)\s+(\d{2}\.\d{2}\.\d{4})\s+(\S+)\s+(\d{1,2}:\d{2})\s+(\d{1,2}:\d{2})(?:.*?(\d{6}))?/);
                        
                        if (match) {  
                            const surname = match[1];
                            const name = match[2];
                            const dateStr = match[3];
                            const shiftNumber = match[4];
                            const startTime = match[5];
                            const endTime = match[6];
                            let matricola = match[7] || null;  

                            if (!matricola) {  
                                const normalizePart = (str) => str.replace(/[^a-zA-Z]/g, '').substring(0, Math.min(str.length, 3)).toUpperCase();
                                matricola = `${normalizePart(surname)}${normalizePart(name)}${Math.floor(Math.random() * 900) + 100}`;  
                            }

                            const [day, month, year] = dateStr.split('.');
                            const isoDate = `${year}-${month}-${day}`;

                            const fascia = calculateFascia(startTime, endTime);
                            const normalizeEmailPart = (str) => str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f\s\.]/g, '');  
                            const email = `${normalizeEmailPart(name)}.${normalizeEmailPart(surname)}@sbb.ch`;

                            const macchinistaKey = matricola;  
                            if (!organizedData[macchinistaKey]) {
                                organizedData[macchinistaKey] = {
                                    name: name,
                                    surname: surname,
                                    matricola: matricola,
                                    email: email,
                                    shifts: []
                                };
                            }
                            organizedData[macchinistaKey].shifts.push({
                                date: isoDate,  
                                number: shiftNumber,
                                start: startTime,
                                end: endTime,
                                fascia: fascia,
                                originalLine: line  
                            });
                        } else {
                            console.warn('Skipping malformed or unrecognized line in Cambio Fascia Oraria:', line);
                            showToast(`Attenzione: Riga non riconosciuta in Cambio Fascia: "${line.substring(0, Math.min(line.length, 50))}..."`);
                        }
                    } catch (e) {
                        console.error('Error parsing line in Cambio Fascia Oraria:', line, e);
                        showToast(`Errore grave durante l'analisi di una riga: "${line.substring(0, Math.min(line.length, 50))}..."`);
                    }
                });

                for (const key in organizedData) {
                    organizedData[key].shifts.sort((a, b) => new Date(a.date) - new Date(b.date));
                }
                return organizedData;
            }
            
            // Function to generate the HTML for the interactive report in the modal
            function generateInteractiveShiftReportHtml(organizedData) {
                let html = `
                    <h2 style="text-align:center;font-size:20px;font-weight:bold;margin-bottom:20px;">Turni Organizzati per Fascia Oraria (da dati incollati)</h2>
                `;
                
                if (Object.keys(organizedData).length === 0) {
                    html += '<p style="text-align:center; padding:20px;">Nessun dato valido elaborato dai dati incollati. Assicurati che il formato sia corretto: Cognome Nome DD.MM.YYYY NumeroTurno HH:MM HH:MM</p>';
                    return { html: html }; // Return as an object for openModal
                }

                for (const macchinistaKey in organizedData) {
                    const person = organizedData[macchinistaKey];
                    html += `
                        <div class="modal-shift-row" data-macchinista-id-group="${person.matricola}">
                            <input type="checkbox" class="macchinista-select-all-checkbox" data-macchinista-id="${person.matricola}">
                            <div class="modal-shift-info">
                                <span>${person.surname} ${person.name} (${person.matricola || 'N/A'}) - ${person.email}</span>
                                <table>
                                    <thead>
                                        <tr>
                                            <th></th> <th>Data</th>
                                            <th>Numero Turno</th>
                                            <th>Inizio</th>
                                            <th>Fine</th>
                                            <th>Fascia Oraria</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    person.shifts.forEach(shift => {
                        const formattedDate = new Date(shift.date + 'T00:00:00').toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
                        let fasciaClass = '';
                        switch(shift.fascia) {
                            case 'Presto': fasciaClass = 'fascia-presto'; break;
                            case 'Medio': fasciaClass = 'fascia-medio'; break;
                            case 'Tardi': fasciaClass = 'fascia-tardi'; break;
                            default: fasciaClass = 'fascia-sconosciuta';
                        }
                        html += `
                                        <tr>
                                            <td>
                                                <input type="checkbox" class="shift-select-checkbox"
                                                    data-macchinista-id="${person.matricola}"
                                                    data-macchinista-name="${person.name}"
                                                    data-macchinista-surname="${person.surname}"
                                                    data-macchinista-email="${person.email}"
                                                    data-date="${shift.date}"
                                                    data-shift-number="${shift.number}"
                                                    data-start-time="${shift.start}"
                                                    data-end-time="${shift.end}"
                                                    data-fascia="${shift.fascia}">
                                            </td>
                                            <td>${formattedDate}</td>
                                            <td>${shift.number}</td>
                                            <td>${shift.start}</td>
                                            <td>${shift.end}</td>
                                            <td class="${fasciaClass}">${shift.fascia}</td>
                                        </tr>
                                        `;
                    });
                    html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }

                return { html: html };  // Return as an object for openModal
            }

            // Function to update the state of the "Genera Email Selezionati" button
            function updateGenerateSelectedShiftsButtonState() {
                const selectedCheckboxes = document.querySelectorAll('#reportModal .shift-select-checkbox:checked');
                if (selectedCheckboxes.length > 0) {
                    generateSelectedShiftsEmailBtn.classList.remove('hidden');
                } else {
                    generateSelectedShiftsEmailBtn.classList.add('hidden');
                }
            }

            // Function to generate email for selected shifts directly from the modal report
            generateSelectedShiftsEmailBtn.addEventListener('click', function() {
                const selectedShiftsData = [];
                document.querySelectorAll('#reportModal .shift-select-checkbox:checked').forEach(checkbox => {
                    selectedShiftsData.push({
                        macchinistaId: checkbox.dataset.macchinistaId,
                        macchinistaName: checkbox.dataset.macchinistaName,
                        macchinistaSurname: checkbox.dataset.macchinistaSurname,
                        macchinistaEmail: checkbox.dataset.macchinistaEmail,
                        date: checkbox.dataset.date,
                        shiftNumber: checkbox.dataset.shiftNumber,
                        startTime: checkbox.dataset.startTime,
                        endTime: checkbox.dataset.endTime,
                        fascia: checkbox.dataset.fascia
                    });
                });

                if (selectedShiftsData.length === 0) {
                    showToast("Seleziona almeno un turno per generare l'email.");
                    return;
                }

                // Group shifts by macchinista to send a single email per macchinista with all their selected shifts
                const emailsToSend = {};
                selectedShiftsData.forEach(shift => {
                    const emailKey = shift.macchinistaEmail;
                    if (!emailsToSend[emailKey]) {
                        emailsToSend[emailKey] = {
                            name: shift.macchinistaName,
                            surname: shift.macchinistaSurname,
                            email: shift.macchinistaEmail,
                            shifts: []
                        };
                    }
                    emailsToSend[emailKey].shifts.push(shift);
                });

                // Prepare and open mailto links for each macchinista
                for (const emailKey in emailsToSend) {
                    const person = emailsToSend[emailKey];
                    let emailBody = `Buongiorno ${person.name},\n\n`;
                    emailBody += `ti chiediamo gentilmente di verificare la possibilità di modificare la fascia oraria dei seguenti turni, al fine di ottimizzare la gestione del personale, garantire un corretto passaggio ed evitare situazioni di esubero o fluttuazioni:\n\n`;

                    person.shifts.forEach(shift => {
                        const formattedDate = new Date(shift.date + 'T00:00:00').toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
                        emailBody += `• Data: ${formattedDate} - Turno: ${shift.shiftNumber} - Fascia: ${shift.fascia} - Orario: ${shift.startTime}-${shift.endTime}\n`;
                    });

                    emailBody += `\nRimariamo a disposizione per eventuali chiarimenti.\n\n`;
                    emailBody += `Cordiali saluti,\n`;
                    emailBody += `Ripartizione del personale – P-O-BP-ZFR-MSD-EIN\n`;
                    emailBody += `Ferrovie Federali Svizzere – FFS\n`;
                    emailBody += `Produzione ferroviaria – Condotta dei treni e manovra\n`;
                    emailBody += `6500 Bellinzona\n`;

                    const subject = "Verifica Modifica Fascia Oraria Turni";
                    const mailtoLink = `mailto:${encodeURIComponent(person.email)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
                    
                    // Open a new email for each selected macchinista
                    window.open(mailtoLink, '_blank');
                }
                showToast("Email generate per i turni selezionati!");
            });

            // Event listener for the main button in Pane 6
            processShiftDataBtnForFascia.addEventListener('click', function() {
                const rawData = shiftDataPasteAreaForFascia.value;
                if (!rawData.trim()) {
                    showToast("Incolla i dati dei turni prima di organizzare.");
                    return;
                }
                const organizedShifts = parseAndOrganizeShiftDataForFascia(rawData);
                
                // Set the report modal content and open it
                openModal(() => generateInteractiveShiftReportHtml(organizedShifts), 'Turni Organizzati per Fascia Oraria');

                // Clear existing proposals in pane6 and the set of added proposals
                fasciaCambiPropostiContainer.innerHTML = '<p class="text-gray-500 text-sm">Organizza i turni per vedere le proposte di cambio.</p>'; // Reset message
                // This 'addedProposals' variable was not defined in the previous snippet,
                // if it's meant to track proposals in Pane 6, it needs to be initialized.
                // For now, I'll assume it's just meant to clear the container, as per the original logic.
                // If you have a specific 'addedProposals' Set or Array, ensure it's cleared here too.
                // Example if it was a Set: addedProposals.clear();  

                // Generate and display proposals in pane6 (this is the automatic block detection logic)
                // This function was also not defined in the provided snippet.  
                // If it exists elsewhere in your full script, ensure it's present.
                // For the purpose of providing the *entire script*, I'll add a placeholder function.
                generateSwapProposals(organizedShifts);  
            });

            // Placeholder for generateSwapProposals if it's not defined elsewhere in your original script
            // This function would typically take the organizedShifts and identify potential "swap proposals"
            // based on your business logic (e.g., finding a "Presto" shift that can be swapped with a "Tardi" shift for different macchinisti).
            // For now, it just adds a simple message. You'll need to implement your actual logic here.
            const addedProposals = new Set(); // Assuming this was meant to be defined globally for pane 6 logic

            function generateSwapProposals(organizedShifts) {
                // Clear the container first
                fasciaCambiPropostiContainer.innerHTML = '';  

                if (Object.keys(organizedShifts).length === 0) {
                    fasciaCambiPropostiContainer.innerHTML = '<p class="text-gray-500 text-sm">Nessun turno organizzato per generare proposte di cambio.</p>';
                    return;
                }

                let hasProposals = false;

                // Example: Find a "Presto" shift and suggest finding someone for a "Tardi" shift.
                // This is a simplified example. Your actual logic for proposals will be more complex.
                for (const macchinistaKey in organizedShifts) {
                    const person = organizedShifts[macchinistaKey];
                    person.shifts.forEach(shift => {
                        if (shift.fascia === 'Presto') {
                            const proposalId = `${person.matricola}-${shift.date}-${shift.number}-presto`;
                            if (!addedProposals.has(proposalId)) {
                                const proposalHtml = `
                                    <div class="proposal-block type-presto">
                                        <h4>Proposta Cambio Fascia: Presto</h4>
                                        <p><strong>${person.name} ${person.surname} (${person.matricola})</strong> ha un turno <strong>Presto (${shift.number})</strong> il <strong>${new Date(shift.date + 'T00:00:00').toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' })}</strong> dalle ${shift.start} alle ${shift.end}. Potrebbe aver bisogno di un cambio con un turno Tardi.</p>
                                    </div>
                                `;
                                fasciaCambiPropostiContainer.insertAdjacentHTML('beforeend', proposalHtml);
                                addedProposals.add(proposalId);
                                hasProposals = true;
                            }
                        } else if (shift.fascia === 'Tardi') {
                               const proposalId = `${person.matricola}-${shift.date}-${shift.number}-tardi`;
                            if (!addedProposals.has(proposalId)) {
                                const proposalHtml = `
                                    <div class="proposal-block type-tardi">
                                        <h4>Proposta Cambio Fascia: Tardi</h4>
                                        <p><strong>${person.name} ${person.surname} (${person.matricola})</strong> ha un turno <strong>Tardi (${shift.number})</strong> il <strong>${new Date(shift.date + 'T00:00:00').toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' })}</strong> dalle ${shift.start} alle ${shift.end}. Potrebbe essere disponibile per un cambio.</p>
                                    </div>
                                `;
                                fasciaCambiPropostiContainer.insertAdjacentHTML('beforeend', proposalHtml);
                                addedProposals.add(proposalId);
                                hasProposals = true;
                            }
                        }
                    });
                }

                if (!hasProposals) {
                    fasciaCambiPropostiContainer.innerHTML = '<p class="text-gray-500 text-sm">Nessuna proposta di cambio rilevata dai turni organizzati.</p>';
                } else {
                    showToast('Proposte di cambio generate!');
                }
            }


        } catch (error) {
            console.error("ERRORE FATALE in initializeApp:", error);
            document.body.innerHTML = `<div style="padding:2rem; text-align:center; background-color: #fef2f2; border: 1px solid #ef4444; border-radius: 0.5rem; margin: 2rem;">
                <h1 style="color: #ef4444; font-size: 2rem; font-weight: bold; margin-bottom: 1rem;">Errore Critico</h1>
                <p style="color: #ef4444; font-size: 1rem;">Si è verificato un errore che impedisce il funzionamento dell'applicazione.</p>
                <p style="color: #ef4444; font-size: 0.875rem; margin-top: 0.5rem;">Dettagli tecnici: ${error.message}</p>
                <p style="color: #ef4444; font-size: 0.875rem;">Si prega di segnalare questo errore all'amministratore.</p>
            </div>`;
        }
    });
    </script>
</body>
</html>
